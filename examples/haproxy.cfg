global
    log stdout format raw local0
    maxconn 4096

defaults
    mode tcp
    log global
    option tcplog
    timeout connect 10s
    timeout client 30m
    timeout server 30m

# HAProxy stats page
listen stats
    bind *:9000
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats show-legends
    stats show-node

# NFS frontend
frontend nfs_frontend
    bind *:2049
    mode tcp
    default_backend nfs_active

# NFS backend - only route to active (healthy) node
backend nfs_active
    mode tcp
    balance leastconn
    option tcp-check
    # HTTP health check on port 8080
    option httpchk GET /ready
    http-check expect status 200
    
    server node1 zerofs-node1:2049 check port 8080 inter 2s fall 3 rise 2
    server node2 zerofs-node2:2049 check port 8080 inter 2s fall 3 rise 2 backup
    server node3 zerofs-node3:2049 check port 8080 inter 2s fall 3 rise 2 backup

# 9P frontend
frontend ninep_frontend
    bind *:5564
    mode tcp
    default_backend ninep_active

# 9P backend - only route to active (healthy) node
backend ninep_active
    mode tcp
    balance leastconn
    option tcp-check
    option httpchk GET /ready
    http-check expect status 200
    
    server node1 zerofs-node1:5564 check port 8080 inter 2s fall 3 rise 2
    server node2 zerofs-node2:5564 check port 8080 inter 2s fall 3 rise 2 backup
    server node3 zerofs-node3:5564 check port 8080 inter 2s fall 3 rise 2 backup


