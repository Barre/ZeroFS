version: '3.8'

# Example Docker Compose setup for ZeroFS HA cluster
# This demonstrates a 3-node cluster with S3 lease-based coordination

services:
  # Node 1
  zerofs-node1:
    image: zerofs:latest
    command: ["run", "-c", "/etc/zerofs/config.toml"]
    environment:
      - NODE_ID=node-1
      - ZEROFS_PASSWORD=${ZEROFS_PASSWORD}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
    volumes:
      - ./ha-config-lease.toml:/etc/zerofs/config.toml:ro
      - node1-cache:/var/cache/zerofs
    ports:
      - "12049:2049"  # NFS (different host port to avoid conflict with HAProxy)
      - "15564:5564"  # 9P
      - "8081:8080"   # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # Node 2
  zerofs-node2:
    image: zerofs:latest
    command: ["run", "-c", "/etc/zerofs/config.toml"]
    environment:
      - NODE_ID=node-2
      - ZEROFS_PASSWORD=${ZEROFS_PASSWORD}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
    volumes:
      - ./ha-config-lease.toml:/etc/zerofs/config.toml:ro
      - node2-cache:/var/cache/zerofs
    ports:
      - "12050:2049"  # NFS (different host port)
      - "15565:5564"  # 9P
      - "8082:8080"   # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # Node 3
  zerofs-node3:
    image: zerofs:latest
    command: ["run", "-c", "/etc/zerofs/config.toml"]
    environment:
      - NODE_ID=node-3
      - ZEROFS_PASSWORD=${ZEROFS_PASSWORD}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
    volumes:
      - ./ha-config-lease.toml:/etc/zerofs/config.toml:ro
      - node3-cache:/var/cache/zerofs
    ports:
      - "12051:2049"  # NFS (different host port)
      - "15566:5564"  # 9P
      - "8083:8080"   # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # HAProxy load balancer (optional)
  haproxy:
    image: haproxy:2.8
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "2049:2049"   # NFS frontend
      - "5564:5564"   # 9P frontend
      - "9000:9000"   # Stats page
    depends_on:
      - zerofs-node1
      - zerofs-node2
      - zerofs-node3
    restart: unless-stopped

volumes:
  node1-cache:
  node2-cache:
  node3-cache:

